<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>论坛系统 | ahao</title><meta name="keywords" content="项目"><meta name="author" content="ahao"><meta name="copyright" content="ahao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="项目介绍本项目是一套前后端不分离的论坛系统，基于目前主流 Java Web 技术栈（SpringBoot + MyBatis + MySQL + Redis + Kafka + Elasticsearch + Spring Security + …），包含了帖子、评论、私信、系统通知、点赞、关注、搜索、用户设置、数据统计等模块。 可访问地址：吃瓜论坛 相关技术 项目结构后端本项目后端采用 MVC">
<meta property="og:type" content="article">
<meta property="og:title" content="论坛系统">
<meta property="og:url" content="https://ahao.ink/posts/%E8%AE%BA%E5%9D%9B%E7%B3%BB%E7%BB%9F/index.html">
<meta property="og:site_name" content="ahao">
<meta property="og:description" content="项目介绍本项目是一套前后端不分离的论坛系统，基于目前主流 Java Web 技术栈（SpringBoot + MyBatis + MySQL + Redis + Kafka + Elasticsearch + Spring Security + …），包含了帖子、评论、私信、系统通知、点赞、关注、搜索、用户设置、数据统计等模块。 可访问地址：吃瓜论坛 相关技术 项目结构后端本项目后端采用 MVC">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/01/17/oZBdwSKr47scYkI.png">
<meta property="article:published_time" content="2022-01-01T05:36:41.000Z">
<meta property="article:modified_time" content="2022-01-18T08:31:35.397Z">
<meta property="article:author" content="ahao">
<meta property="article:tag" content="项目">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/01/17/oZBdwSKr47scYkI.png"><link rel="shortcut icon" href="https://i.loli.net/2021/11/12/NAU53jI9mGOJlDC.png"><link rel="canonical" href="https://ahao.ink/posts/%E8%AE%BA%E5%9D%9B%E7%B3%BB%E7%BB%9F/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-01-18 16:31:35'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><link rel="stylesheet" href="APlayer.min.css"><div id="aplayer"></div><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js" async></script><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://i.loli.net/2021/11/12/Edhsr56wxfUbuFg.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">30</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 读书</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2022/01/17/oZBdwSKr47scYkI.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">ahao</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 读书</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">论坛系统</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-01-01T05:36:41.000Z" title="发表于 2022-01-01 13:36:41">2022-01-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-01-18T08:31:35.397Z" title="更新于 2022-01-18 16:31:35">2022-01-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Projects/">Projects</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">13.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>42分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="论坛系统"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a>项目介绍</h1><p>本项目是一套前后端不分离的论坛系统，基于目前主流 Java Web 技术栈（SpringBoot + MyBatis + MySQL + Redis + Kafka + Elasticsearch + Spring Security + …），包含了帖子、评论、私信、系统通知、点赞、关注、搜索、用户设置、数据统计等模块。</p>
<p>可访问地址：<a target="_blank" rel="noopener" href="http://122.112.244.115/">吃瓜论坛</a></p>
<h1 id="相关技术"><a href="#相关技术" class="headerlink" title="相关技术"></a>相关技术</h1><p><img src="https://s2.loli.net/2022/01/18/omXVMfjzbApcH4L.png" alt="img"></p>
<h1 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h1><h2 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h2><p>本项目后端采用 MVC 模式，使用现在流行的 SpringBoot 框架。</p>
<p><img src="https://s2.loli.net/2022/01/17/gqfxTAHwGoRjVd6.png" alt="项目结构"></p>
<h3 id="entity"><a href="#entity" class="headerlink" title="entity"></a>entity</h3><p><img src="https://s2.loli.net/2022/01/17/nNkgKO91iPjmsfH.png" alt="数据模型"></p>
<ul>
<li>User：数据库模型，对应表 user</li>
<li>Comment：数据库模型，对应表 comment</li>
<li>DiscussPost：数据库模型，对应表 discuss_post</li>
<li>Message：数据库模型，对应表 message</li>
<li>Page：分页模型</li>
<li>Event：事件模型（Spring Kafka）</li>
<li>LoginTicket：登录凭证</li>
</ul>
<h3 id="dao"><a href="#dao" class="headerlink" title="dao"></a>dao</h3><p><img src="https://s2.loli.net/2022/01/17/16p7iaqBGOzg4No.png" alt="dao"></p>
<ul>
<li>CommentMapper：控制 Comment 的相关数据库操作</li>
<li>DiscussPostMapper：控制 DiscussPost 的相关数据库操作</li>
<li>MessageMapper：控制 Message 的相关数据库操作</li>
<li>UserMapper：控制 User 的相关数据库操作</li>
<li>DiscussPostRepository：控制 Elasticsearch 服务器上 DiscussPost 的相关操作</li>
</ul>
<p>这些都为操作接口，操作数据库的文件放在<code>resources/mapper</code> 目录下：</p>
<p><img src="https://s2.loli.net/2022/01/17/tquesVKQJWl8PYd.png" alt="mapper"></p>
<h3 id="service"><a href="#service" class="headerlink" title="service"></a>service</h3><p><img src="https://s2.loli.net/2022/01/17/b2lYQapfJrkGDL8.png" alt="service"></p>
<ul>
<li>CommentService：Comment 相关的业务逻辑</li>
<li>UserService：User 相关的业务逻辑</li>
<li>MessageService：Message 相关的业务逻辑</li>
<li>DiscussPostService：DiscussPost 相关的业务逻辑</li>
<li>FollowService：关注相关的业务逻辑</li>
<li>LikeService：点赞相关的业务逻辑</li>
<li>ElasticsearchService：Elasticsearch 搜索相关的业务逻辑</li>
<li>DataService：数据统计相关的业务逻辑</li>
</ul>
<h3 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h3><p><img src="https://s2.loli.net/2022/01/17/L8DTtYSikQoj2mc.png" alt="controller"></p>
<ul>
<li><p>UserController：控制 User 相关的业务流程</p>
</li>
<li><p>CommentController：控制 Comment 相关的业务流程，比如添加评论等</p>
</li>
<li><p>DiscussPostController：控制 DiscussPost相关的业务流程，比如添加帖子、进入帖子详情页、置顶帖子、加精帖子等</p>
</li>
<li><p>MesaageController：控制 Message 相关的业务流程，比如进行私信列表、发送私信、发送系统通知等</p>
</li>
<li><p>LikeController：控制点赞相关的业务流程，比如点赞、取消点赞等</p>
</li>
<li><p>FollowController：控制关注相关的业务流程，比如关注、取消关注、进入某个用户的关注列表等</p>
</li>
<li><p>SearchController：控制搜索相关的业务流程，比如进入搜索界面等</p>
</li>
<li><p>DataController：控制数据统计相关的业务流程，比如进入统计界面、统计网站 DAU、统计网站 uv 等</p>
</li>
<li><p>IndexController：控制首页相关的业务流程，比如进入首页、进入 500/404 错误界面等</p>
</li>
<li><p>LoginController：控制登录注册相关的业务流程，比如登录、登出、注册、激活用户等</p>
</li>
<li><p>advice：</p>
<ul>
<li>ExceptionAdvice：处理服务端异常（500）</li>
</ul>
</li>
<li><p>interceptor：拦截器</p>
<ul>
<li><p>MessageInterceptor：获取未读私信/系统通知的数量</p>
</li>
<li><p>LoginTicketInterceptor：检查凭证状态，若凭证有效则在本次请求中持有该用户信息</p>
</li>
<li><p>DataInterceptor：统计网站 UV 和 DAU</p>
</li>
</ul>
</li>
</ul>
<h3 id="util"><a href="#util" class="headerlink" title="util"></a>util</h3><p><img src="https://s2.loli.net/2022/01/17/JaEsxHNDX6IOzv2.png" alt="util"></p>
<ul>
<li>CommunityUtil：通用工具类。比如生成随机字符串、md5 加密、将服务端返回的消息封装成 JSON 格式的字符串等</li>
<li>CookieUtil：从 request 中获取指定 name 的 cookie</li>
<li>HostHolder：使用 ThreadLocal 持有用户信息（多线程），用于代替 session 对象，实现 session any where</li>
<li>MailClient：发送激活邮件（用于注册）</li>
<li>RedisKeyUtil：生成 Redis 的 key</li>
<li>SensitiveFilter：敏感词过滤器。对应的敏感词文本文件就是 <code>sensitive-words.txt</code></li>
</ul>
<p><img src="https://s2.loli.net/2022/01/17/3fN9gy2BROXPGCK.png" alt="SensitiveFilter"></p>
<h3 id="event"><a href="#event" class="headerlink" title="event"></a>event</h3><p>这个包主要是提供给 Spring Kafka 使用的：</p>
<p><img src="https://s2.loli.net/2022/01/17/y4HBdtGuJLoCp6a.png" alt="event"></p>
<ul>
<li>EventProducer：事件的生产者（将事件发布到指定的主题）</li>
<li>EventConsumer：事件的消费者</li>
</ul>
<h3 id="quartz"><a href="#quartz" class="headerlink" title="quartz"></a>quartz</h3><p><img src="https://s2.loli.net/2022/01/17/ISVD7yn9cBj1aOf.png" alt="image-20220117105200590"></p>
<ul>
<li>PostScoreRefreshJob：每隔一段时间刷新帖子分数（热度）</li>
</ul>
<h3 id="config"><a href="#config" class="headerlink" title="config"></a>config</h3><p><img src="https://s2.loli.net/2022/01/17/hu7VqabSdfYsgc8.png" alt="config"></p>
<ul>
<li>KaptchaConfig：Kaptcha（验证码）相关配置</li>
<li>QuartzConfig：Spring Quartz 相关配置</li>
<li>RedisConfig：Redis 相关配置</li>
<li>SecurityConfig：Spring Security 相关配置</li>
<li>WebMvcConfig：拦截器相关配置</li>
</ul>
<h3 id="ascept"><a href="#ascept" class="headerlink" title="ascept"></a>ascept</h3><p><img src="https://s2.loli.net/2022/01/17/sTOxb3jZmePYFQd.png" alt="ascept"></p>
<ul>
<li>ServiceLogAspect：使用 AOP实现统一日志记录</li>
</ul>
<h2 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h2><h3 id="前端静态资源"><a href="#前端静态资源" class="headerlink" title="前端静态资源"></a>前端静态资源</h3><p>存放在resources/static目录下</p>
<p><img src="https://s2.loli.net/2022/01/17/LKoBn4IiJw7MmcQ.png" alt="静态资源"></p>
<h3 id="页面模板"><a href="#页面模板" class="headerlink" title="页面模板"></a>页面模板</h3><p><img src="https://s2.loli.net/2022/01/17/xEPT3dufr6zWYSF.png" alt="image-20220117112606784"></p>
<ul>
<li><p>error：错误界面模板</p>
</li>
<li><p>mail：邮件模板</p>
<ul>
<li><p>activation.html：激活邮件模板</p>
</li>
<li><p>forget.html：找回密码邮件模板（暂未使用）</p>
</li>
</ul>
</li>
<li><p>forget.html：忘记密码页面模板（暂未使用）</p>
</li>
<li><p>operate-result.html：操作结果页模板</p>
</li>
<li><p>login.html：登录页模板</p>
</li>
<li><p>register.html：注册页模板</p>
</li>
<li><p>index.html：首页（帖子列表页模板）</p>
</li>
<li><p>discuss-detail.html：帖子详情页模板</p>
</li>
<li><p>profile.html：个人主页模板</p>
</li>
<li><p>my-post.html：我的帖子模板</p>
</li>
<li><p>my-reply.html：我的回复页模板</p>
</li>
<li><p>followee-detail.html：关注列表模板</p>
</li>
<li><p>follower-detail.html：粉丝模板</p>
</li>
<li><p>letter.html：私信列表模板</p>
</li>
<li><p>letter-detail.html：私信详情页模板</p>
</li>
<li><p>notice.html：系统通知页模板</p>
</li>
<li><p>notice-detail.html：系统通知详情页模板</p>
</li>
<li><p>search.html：搜索结果页模板</p>
</li>
<li><p>setting.html：账号设置页模板</p>
</li>
<li><p>data.html：数据统计模板</p>
</li>
</ul>
<h1 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h1><p>本项目数据库设计并不复杂，需要我们手动设计的只有四张表：</p>
<ul>
<li><p>用户表：<code>user</code></p>
</li>
<li><p>帖子表：<code>discuss_post</code></p>
</li>
<li><p>评论表：<code>comment</code></p>
</li>
<li><p>私信表：<code>message</code></p>
</li>
</ul>
<h2 id="用户表"><a href="#用户表" class="headerlink" title="用户表"></a>用户表</h2><p><img src="https://s2.loli.net/2022/01/17/81b3lpPoOQS4CgH.png" alt="用户表"></p>
<p>各个字段的含义：</p>
<ul>
<li><p>id：用户的唯一标识</p>
</li>
<li><p>username：用户名</p>
</li>
<li><p>password：存储加盐加密后的密码</p>
</li>
<li><p>salt：随机生成的盐，用于密码的加盐加密</p>
</li>
<li><p>email：邮箱</p>
</li>
<li><p>type：用户类型</p>
<ul>
<li>0 - 普通用户（用户注册默认是普通用户）</li>
</ul>
</li>
<li><ul>
<li>1 - 超级管理员：具有删除帖子、访问数据统计界面的权限</li>
</ul>
</li>
<li><ul>
<li>2 - 版主：具有置顶、加精帖子权限</li>
</ul>
</li>
<li><p>status：用户状态</p>
</li>
<li><ul>
<li>0 - 未激活（默认）：用户点击注册后未点击邮箱中的激活链接进行验证，就会处于这个状态。未激活的用户同样无法正常使用某些功能比如发表帖子等</li>
<li>1 - 已激活：用户点击邮箱中的激活链接进行验证成功，就会将状态从未激活改成已激活</li>
</ul>
</li>
<li><p>activation_code：激活码。用户点击注册后，随机生成一串激活码，则在本地环境下：<code>http://localhost:8080/greatecommunity/activation/用户id/激活码</code> 成为该用户的激活链接；</p>
<p>在服务器上：<code>http://122.112.244.115/activation/用户id/激活码</code> 成为该用户的激活链接。点击该激活链接则激活用户。激活的逻辑，就是检查一下这个链接中的用户 id 和激活码是否和数据库中存储的一样。</p>
</li>
</ul>
<h2 id="帖子表"><a href="#帖子表" class="headerlink" title="帖子表"></a>帖子表</h2><p><img src="https://s2.loli.net/2022/01/17/odqehQ8MTPGLtci.png" alt="帖子表"></p>
<p>各个字段的含义：</p>
<ul>
<li><p>id：帖子的唯一标识</p>
</li>
<li><p>user_id：发表该帖子的用户的 id</p>
</li>
<li><p>title：帖子标题</p>
</li>
<li><p>content：帖子内容</p>
</li>
<li><p>type：帖子类型</p>
</li>
<li><ul>
<li>0 - 普通帖子（默认）</li>
<li>1 - 置顶帖子</li>
</ul>
</li>
<li><p>status：帖子状态</p>
</li>
<li><ul>
<li>0 - 正常（默认）</li>
<li>1 - 精华：为帖子加精可以使其在热度计算中得到一定的加分</li>
<li>2 - 拉黑：管理员删除帖子后，就将这个帖子的状态设置为拉黑</li>
</ul>
</li>
<li><p>create_time：帖子发表时间</p>
</li>
<li><p>comment_count：帖子的评论数量（因为会频繁的显示帖子的信息，比如创建时间、创建人、评论数量、点赞数量等，创建时间和创建人信息这张表中已经有了，所以此处再将评论数量存进来就好。可能会有同学会问啥不把点赞数量也缓存到帖子表中，因为点赞数量是存在 Redis 中的，获取点赞数量咱连数据库都不用进的，还费劲在这存一份干啥）</p>
</li>
<li><p>score：热度 / 分数（用于按照热度排行帖子）</p>
</li>
</ul>
<h2 id="评论表"><a href="#评论表" class="headerlink" title="评论表"></a>评论表</h2><p><img src="https://s2.loli.net/2022/01/17/ZbAKmYHSiNJQdf4.png" alt="评论表"></p>
<ul>
<li><p>id：评论/回复的唯一标识</p>
</li>
<li><p>user_id：用户 id（哪个用户发布了这个评论/回复）</p>
</li>
<li><p>entity_type：实体类型（表示这条 comment 是针对哪个类型的，如果是针对帖子的，那么这个 comment 就是评论；如果是针对评论的，那么这条 comment 就是回复）</p>
</li>
<li><p>entity_id：实体的 id（如果是对帖子的评论，就存储帖子的 id；如果是对评论的回复，就存储评论的 id；还有对回复的回复，存储的仍然是所属评论的 id。也就是说，<strong>「某个帖子下的所有评论，它们的 entity_id 都是这个帖子的 id。某条评论下的所有回复，它们的 entity_id 都是这条评论的 id」</strong>。）</p>
</li>
<li><p>target_id：目标用户 id（表示这条评论/回复是针对哪个用户的。比如用户 admin 发了一个帖子，用户 master 评论了这个帖子，那么这里的 target_id 存储的就是用户 admin 的 id。）</p>
</li>
<li><p>content：评论/回复的内容</p>
</li>
<li><p>status：评论/回复状态</p>
</li>
<li><ul>
<li>0 - 正常（默认）</li>
<li>1 - 禁用（暂未使用）</li>
</ul>
</li>
<li><p>create_time：评论/回复发布时间</p>
</li>
</ul>
<h2 id="消息表"><a href="#消息表" class="headerlink" title="消息表"></a>消息表</h2><p>这张表存储用户之间的私信消息，也存储系统通知，不同的是，系统通知的 from_id 特定为 1。用于发送系统通知的角色（用户） <code>SYSTEM</code> 已内置。</p>
<p><img src="https://s2.loli.net/2022/01/17/oz3JFQCjEBeAtiD.png" alt="image-20220117131057933"></p>
<ul>
<li><p>id：私信/系统通知的唯一标识</p>
</li>
<li><p>from_id：私信/系统通知的发送方 id</p>
</li>
<li><p>to_id：私信/系统通知的接收方 id</p>
</li>
<li><p>conversation_id：标识两个用户之间的对话。比如用户 id 112 给 113 发消息，或者 113 给 112 发消息，这两个会话的 <code>conservation_id</code> 都是 <code>112_113</code>。这样，通过这个字段我们就能查出来 112 和 113 之间的私信往来了。当然，这个字段是冗余的，我们可以通过 from_id 和 to_id 推演出来，但是有了这个字段方便后面的查询等操作</p>
</li>
<li><p>content：私信/系统通知的内容</p>
</li>
<li><p>status：私信/系统通知的状态</p>
</li>
<li><ul>
<li>0 - 未读（默认）</li>
<li>1 - 已读</li>
<li>2 - 删除（暂未使用）</li>
</ul>
</li>
<li><p>create_time：私信/系统通知的发送时间</p>
</li>
</ul>
<h1 id="开发过程"><a href="#开发过程" class="headerlink" title="开发过程"></a>开发过程</h1><h2 id="开发社区首页"><a href="#开发社区首页" class="headerlink" title="开发社区首页"></a>开发社区首页</h2><h3 id="搭建基本环境"><a href="#搭建基本环境" class="headerlink" title="搭建基本环境"></a>搭建基本环境</h3><p>构建 SpringBoot 的 maven 项目，引入 mysql 和 mybatis 依赖。</p>
<p>在 <code>application.properties</code> 配置文件中：</p>
<ul>
<li>关闭 thymeleaf 缓存 </li>
<li>配置数据库，设置基本连接信息、最大线程数，最小空闲线程数，最大空闲时间等 </li>
<li>mybatis，设置 mapper 文件的位置、实体类包名、使用主键等</li>
</ul>
<p>创建 community 数据库和数据库表。</p>
<p>用户相关操作：</p>
<ul>
<li>创建对应 user 表的 User 实体类 </li>
<li>创建 UserMapper 接口，使用 <code>@Mapper</code> 注解 </li>
<li>创建 user-mapper.xml，重复 sql 语句可以写在 <code>&lt;sql id = &quot;xxx&quot;&gt;</code> 标签，通过 <code>&lt;include refid=&quot;xxx&quot;/&gt;</code> 引用。</li>
</ul>
<h3 id="开发社区首页（discuss-post-表）"><a href="#开发社区首页（discuss-post-表）" class="headerlink" title="开发社区首页（discuss_post 表）"></a>开发社区首页（discuss_post 表）</h3><p>功能拆分：开发社区首页，显示前 10 个帖子。开发分页组件，分页显示所有帖子。</p>
<p>用到的表是 discuss_post 数据库表，包括帖子 id、发帖人 id、标题、内容、类型、状态、发帖时间、评论数量（为了提高效率，避免关联查询，因此冗余存储）、分数（用于进行热度排名）。</p>
<h4 id="开发数据层"><a href="#开发数据层" class="headerlink" title="开发数据层"></a>开发数据层</h4><p>帖子相关操作：</p>
<ul>
<li>创建对应 discuss_post 表的 DisscussPost 实体类。</li>
<li>创建 DisscussPostMapper 接口，使用 <code>@Mapper</code> 注解。<ul>
<li>分页查询中用户 id 是可选参数，通过动态 SQL 选择，如果为 0 就不使用，在开发用户个人主页查询用户发帖记录时需要使用。 </li>
<li>如果只有一个参数，并且在动态 SQL 的 <code>&lt;if&gt;</code> 里使用，必须使用 <code>@Param</code> 加别名。 </li>
</ul>
</li>
<li>创建 <code>disscusspost-mapper.xml</code>。<ul>
<li><code>where status != 2</code> 拉黑的帖子不展现。</li>
<li><code>&lt;if test=&quot;userId!=0&quot;&gt;</code> userID 为 0 时不使用，按照类型，发帖时间排序。</li>
</ul>
</li>
</ul>
<h4 id="开发业务层"><a href="#开发业务层" class="headerlink" title="开发业务层"></a>开发业务层</h4><p>创建 DiscussPostService 类，可以分页查询帖子和帖子数量。</p>
<p>创建 UserService 类，实现根据 id 查询用户功能，因为显示帖子时不显示用户 id，而是显示用户名。</p>
<h4 id="开发视图层"><a href="#开发视图层" class="headerlink" title="开发视图层"></a>开发视图层</h4><p>把静态资源 css、html、img、js 放到 static 目录下。</p>
<p>把模板 mail、site、index.html 放到 template 目录下。</p>
<p>创建 HomeController，<code>getIndexPage</code> 方法，用 map 集合把帖子和用户封装到一起。</p>
<p>修改 <code>index.html</code>，使用 <code>&lt;th:text=&quot;$&#123;map.xxx.xxx&#125;&quot;</code> 动态替换。</p>
<p>【问题】使用帖子关联查询用户时，给查询用户的 <code>findUserById</code> 方法传入了帖子的 <code>getId</code> 方法，应该是 <code>getUserId</code> 方法。</p>
<h4 id="开发分页组件"><a href="#开发分页组件" class="headerlink" title="开发分页组件"></a>开发分页组件</h4><p>创建 Page 实体类，封装分页信息，包括当前页码、显示限制、帖子总数、查询路径等。显示的起始页不能小于 1，最大页不能超过 total。</p>
<p>在 <code>index.html</code> 中，当 <code>page.rows &gt; 0</code> 时显示分页信息。</p>
<p>如果 <code>page.current</code> 等于 1 或 <code>page.total</code>，代表是首页或末页，此时不能点击上一页和下一页，用 <code>disabled</code> 属性实现。</p>
<h2 id="开发注册登录模块"><a href="#开发注册登录模块" class="headerlink" title="开发注册登录模块"></a>开发注册登录模块</h2><h3 id="发送邮件"><a href="#发送邮件" class="headerlink" title="发送邮件"></a>发送邮件</h3><p>在QQ邮箱打开 SMTP 服务。</p>
<p>引入 <code>spring-boot-starter-mail</code> 依赖。</p>
<p>在配置文件配置主机、端口、发送邮箱、授权码等。</p>
<p>创建 MailClient 类，调用 JavaMailSender 发送邮件。</p>
<p>使用 thymeleaf 发送 HTML 邮件，调用 TemplateEngine 把信息封装到 HTML 模板。</p>
<p>【问题】发送邮件成功但没接收到，在垃圾箱中可找到。</p>
<h3 id="注册功能"><a href="#注册功能" class="headerlink" title="注册功能"></a>注册功能</h3><p>把 register.html 地址关联到首页的注册 href 属性。</p>
<p>设置域名、创建 CommunityUtil 工具类，在工具类创建生产随机字符串和 MD5 加密方法。</p>
<p>创建 LoginController，创建 <code>getRegisterPage</code> 方法，跳转注册页面。</p>
<p>在 UserService 中创建 <code>register</code> 方法，判断注册信息合规后插入数据库，发送激活邮件。</p>
<p>在 LoginController 创建 <code>register</code> 方法，调用 UserService 的 <code>register</code> 方法。</p>
<p>创建接口 CommunityConstant，定义激活码的三种状态，成功、重复、失败，让 UserService 和 LoginController 实现该接口。</p>
<p>点击激活邮件的 url 【本地服务器的url】后，服务器通过 LoginController 的 <code>activation</code> 方法查询数据库用户，如果 url 中的激活码和设置的一样，就把用户 status 改为 1。</p>
<h3 id="生成验证码"><a href="#生成验证码" class="headerlink" title="生成验证码"></a>生成验证码</h3><p>在 <code>pom.xml</code> 导入 kaptcha 的 jar 包。</p>
<p>创建配置类 KaptchaConfig，设置验证码的大小、范围、长度等。</p>
<p>在 LoginController 类新增 <code>getKaptcha</code> 方法生成验证码图片。</p>
<p>在 <code>login.html</code> 中，将刷新验证码的链接绑定 <code>refresh_kaptcha</code> 方法，通过 id 选择器获取 img 组件，重新访问 <code>getKaptcha</code> 方法生成验证码图片。</p>
<p>【问题】由于访问同一个生成验证码路径，需要在 url 参数加上一个随机数字，保证会重新请求获取新图片。</p>
<h3 id="登录退出功能（login-ticket-表）"><a href="#登录退出功能（login-ticket-表）" class="headerlink" title="登录退出功能（login_ticket 表）"></a>登录退出功能（login_ticket 表）</h3><p>登录成功时，需要生成一个登录凭证发送给客户端。凭证可以在多个业务中连续地验证用户的登陆状态，凭证信息存储在 login_ticket 数据库表中，status 的 0 和 1 表示有效和无序，expire 表示过期时间。</p>
<p>创建对应 login_ticket 表的 LoginTicket 实体类，对应 login_ticket 数据库表。</p>
<p>创建 LoginTicketMapper 接口，通过 <code>@Insert</code>、<code>@Select</code>、<code>@Update</code> 注解来插入、查询、更新凭证。</p>
<p>在 UserServce </p>
<ul>
<li>创建 <code>login</code> 方法，验证账户合规后将凭证信息插入数据库，添加登录凭证到 map 中。</li>
<li>创建 <code>logout</code> 方法，将对应凭证设为无效。</li>
</ul>
<p>在 LoginController </p>
<ul>
<li>创建 <code>login</code> 方法，判断验证码正确后调用 UserServce 的 <code>login</code> 方法，如果 map 包含 ticket 代表登录成功，重定向跳转首页，否则添加错误信息并跳回登录页。</li>
<li>创建 <code>logout</code> 方法，判断验证码正确后调用 UserServce 的<code>logout</code> 方法，跳转至登录页。</li>
</ul>
<p>在 <code>login.html</code> 绑定登录链接，<code>index.html</code> 绑定退出登录链接。</p>
<p>【问题】登录成功后，创建了凭证，但忘记将凭证信息插入数据库。</p>
<h3 id="显示登录信息"><a href="#显示登录信息" class="headerlink" title="显示登录信息"></a>显示登录信息</h3><p>创建 CookieUtil 工具类，通过 name 查询对应 cookie 的 value。</p>
<p>在 UserService 中新增 <code>findLoginTicket</code> 方法，根据 ticket 查询 LoginTicket。</p>
<p>创建 HostHolder 类用来模拟 session 的功能，利用 ThreadLocal 实现，存储用户信息。</p>
<p>创建 LoginTicketInterceptor 拦截器，实现 HandlerInterceptor 接口。</p>
<ul>
<li>在 <code>preHandle</code> 方法中通过 CookieUtil 的 <code>getValue</code> 方法查询是否有凭证 cookie，如果有则通过 UserService 的 <code>findloginTicket</code> 方法查询用户 ID，再通过用户 ID 查询用户。最后将用户放入 hostHolder 中。 </li>
<li>在 <code>postHandle</code> 方法中通过 hostHolder 的 <code>get</code> 方法获取用户，并将其存入视图中。 </li>
<li>在 <code>afterCompletion</code> 方法中清除 hostHolder 中存放的用户信息。 </li>
</ul>
<p>创建 WebMvcConfig 配置类，实现 WebMvcConfigurer接口，配置 LoginTicketInterceptor，拦截除了静态资源之外的所有路径。</p>
<h3 id="上传头像"><a href="#上传头像" class="headerlink" title="上传头像"></a>上传头像</h3><p>在 UserService 新增 <code>updateHeader</code> 方法，更改指定用户的头像。</p>
<p>创建 UserController</p>
<ul>
<li><p>新增 <code>getSettingPage</code> 方法访问账户设置 <code>setting.html</code> ，并在 <code>index.html</code> 的账号设置按钮关联该链接。</p>
</li>
<li><p>新增 <code>uploadHeader</code> 方法更新用户头像，如果上传出现错误将错误信息存在 Model 对象中。</p>
<p>如果没有错误，生成一个文件对象 dest，利用 MultipartFile 接口的 <code>transferTo</code> 方法将用户上传文件导入 dest，并从 hostHolder 中取出用户，更新用户的头像路径。</p>
</li>
<li><p>新增 <code>getHeader</code> 方法获取用户头像，利用文件输入流读取图片数据，利用 HttpServletResponse 的字节输出流再进行输出。</p>
</li>
</ul>
<p>调整 <code>setting.html</code> 的 form 表单， method=”post”，enctype=”multipart/form-data”，并设置提交路径。</p>
<h3 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h3><p>在 UserService 中新增 <code>changePassword</code> 方法，判断原密码是否正确，正确则修改密码并返回 1，否则返回 0。</p>
<p>在 UserController 中新增 <code>changePassword</code> 方法，根据 UserService 的 <code>changePassword</code> 方法的返回值判断原密码是否成功修改，封装为 JSON 数据并返回。</p>
<p>在 <code>setting.html</code> 中</p>
<ul>
<li>首先在前端判断两次输入的新密码是否一致，如果不一致不允许点击提交并显示错误信息。 </li>
<li>利用 ajax 向 UserController 的 <code>changePassword</code> 方法发送 POST 请求，得到 JSON 数据并解析，如果状态码为 0 提示错误，如果状态码为 1 弹出修改成功提示。 </li>
</ul>
<p>【问题】js 的虚拟路径问题，需要加上 <code>../</code>。</p>
<p>【问题】使用 ajax 请求时，表单按钮类型必须是 button，不能是 submit，否则 405 报错。</p>
<p>【问题】使用 ajax 请求时，Controller 中方法的返回值必须是 JSON 数据，并且需要加上 <code>@ResponseBody</code>。</p>
<p>【问题】使用 ajax 请求时，回调函数需要先对返回的 JSON 数据进行解析再使用。</p>
<h3 id="检查登录状态"><a href="#检查登录状态" class="headerlink" title="检查登录状态"></a>检查登录状态</h3><p>利用拦截器，实现只处理带有自定义注解的方法，防止用户在未登录情况下通过 url 访问没有权限的页面。</p>
<p>创建 <code>@LoginRequired</code> 自定义注解，作用范围在方法上，有效期为运行时。</p>
<p>在 UserController 中需要在登录状态下调用的方法，访问设置页面、修改密码、上传头像等加上自定义注解。</p>
<p>创建 LoginRequiredInterceptor 拦截器，在 <code>preHandle</code> 方法中判断方法是否加了 <code>@LoginRequired</code> 注解，如果加了注解并且此时从 hostHolder 中获取不到用户则拒绝访问。</p>
<p>在 WebMvcConfig 配置类配置 LoginRequiredInterceptor，拦截除了静态资源之外的所有路径。</p>
<h2 id="开发核心功能"><a href="#开发核心功能" class="headerlink" title="开发核心功能"></a>开发核心功能</h2><h3 id="敏感词过滤"><a href="#敏感词过滤" class="headerlink" title="敏感词过滤"></a>敏感词过滤</h3><p>利用字典树数据结构解决。</p>
<p>创建 SensitiveFilter 类</p>
<ul>
<li>创建静态内部类 TrieNode ，通过 boolean 类型的结束符判断是否匹配到关键字尾部。 </li>
<li>利用 <code>@PostConstruct</code> 注解，在构造方法执行后初始化字典树。 </li>
<li>添加 <code>filter</code> 方法，利用双指针进行匹配，过滤敏感词。 </li>
</ul>
<h3 id="发布帖子"><a href="#发布帖子" class="headerlink" title="发布帖子"></a>发布帖子</h3><p>引入 fastjson 依赖，在 CommunityUtil 中新增 <code>getJSONString</code> 方法封装 JSON 信息。</p>
<p>在 DisscussPostMapper 接口新增 <code>insertDiscussPost</code> 方法，并在 <code>disscusspost-mapper.xml</code> 配置 insert 语句。</p>
<p>在 DiscussPostService 新增 <code>addDiscussPost</code> 方法调用 DisscussPostMapper 的 <code>insertDiscussPost</code> 方法，其中需要进行对标题内容和发帖内容进行 HTML 转义以及过滤敏感词。</p>
<p>创建 DiscussPostController 类，新增 <code>addDiscussPost</code> 方法，调用 DiscussPostService 的 <code>addDiscussPost</code> 方法发帖。</p>
<p>在 <code>index.html</code> 中为发帖按钮绑定函数，利用 Ajax 向 DiscussPostController 的 <code>addDiscussPost</code> 方法发送 POST 请求。</p>
<h3 id="显示帖子内容"><a href="#显示帖子内容" class="headerlink" title="显示帖子内容"></a>显示帖子内容</h3><p>在 DisscussPostMapper 接口新增 <code>selectDiscussPostById</code> 方法，在 <code>disscusspost-mapper.xml</code> 配置 select 语句。</p>
<p>在 DiscussPostService 新增 <code>findDiscussPostById</code> 方法调用 DisscussPostMapper 的 <code>selectDiscussPostById</code> 方法。</p>
<p>在 DiscussPostController 新增 <code>getDiscussPost</code> 方法，调用 DiscussPostService 的 <code>findDiscussPostById</code> 方法查询帖子内容，将 DiscussPost 对象和 User 对象（通过 userId 查询，不在 DAO 层关联查询）数据存放到 Model 对象，返回模板 <code>discuss-detail</code>。</p>
<p>在 <code>discuss-detail.html</code> 取出 Model 对象存放的数据绑定到对应组件显示。</p>
<h3 id="显示评论（comment-表）"><a href="#显示评论（comment-表）" class="headerlink" title="显示评论（comment 表）"></a>显示评论（comment 表）</h3><p>创建 comment 表对应的实体类 Comment。</p>
<p>创建 CommentMapper 接口</p>
<ul>
<li>新增 <code>selectCommentsByEntity</code> 方法，根据实体查询一页的评论数据。 </li>
<li>新增 <code>selectCountByEntity</code> 方法，根据实体查询评论的数量。 </li>
<li>在 <code>comment-mapper.xml</code> 配置 select 语句。 </li>
</ul>
<p>创建 CommentService 类</p>
<ul>
<li>新增 <code>findCommentByEntity</code> 方法，调用 CommentMapper 的 <code>selectCommentByEntity</code> 方法。 </li>
<li>新增 <code>findCommentCount</code> 方法，调用 CommentMapper 的 <code>selectCountByEntity</code> 方法。 </li>
</ul>
<p>在 DiscussPostController 的 <code>getDiscussPost</code> 方法中增加查询帖子评论和回复的逻辑，将结果存储在 Model 对象。</p>
<h3 id="添加评论"><a href="#添加评论" class="headerlink" title="添加评论"></a>添加评论</h3><p>在 CommentMapper 接口新增 <code>insertComment</code> 方法，添加评论数据，在 <code>comment-mapper</code> 配置对应 sql。</p>
<p>在 DiscussPostMapper 接口新增 <code>updateCommentCount</code> 方法，增加评论数量，在 <code>discusspost-mapper</code> 配置对应 sql。</p>
<p>在 DiscussPostService 类新增 <code>updateCommentCount</code> 方法，调用 DiscussPostMapper 的 <code>updateCommentCount</code> 方法。</p>
<p>在 CommentService 类新增 <code>addComment</code> 方法，调用 CommentMapper 的 <code>insertComment</code> 新增评论，并调用 DiscussPostService 的 <code>updateCommentCount</code> 更新评论数量，使用 <code>@Transactional</code> 注解保证事务。</p>
<p>创建 CommentController 类，新增 <code>addComment</code> 方法，从 hostHolder 获取用户信息，然后调用 CommentService 的 <code>addComment</code> 方法添加评论。</p>
<h3 id="显示私信列表-（message-表）"><a href="#显示私信列表-（message-表）" class="headerlink" title="显示私信列表 （message 表）"></a>显示私信列表 （message 表）</h3><p>创建对应 message 表的实体类 Message。</p>
<p>创建 MessageMapper 接口，增加查询会话列表、会话数量、私信列表、私信数量、未读私信数量等方法，在 <code>message-mapper.xml</code> 中配置对应的 sql。</p>
<p>创建 MessageService，调用 MessageMapper 中的方法。</p>
<p>创建 MessgaeController</p>
<ul>
<li>新增 <code>getLetterList</code> 方法，将会话列表信息存储到 Model 对象，返回 <code>letter</code> 视图。 </li>
<li>新增 <code>getLetterDetail</code> 方法，将每个会话具体的私信信息存储到 Model 对象，返回 <code>letter-datail</code> 视图。</li>
</ul>
<h3 id="发送私信"><a href="#发送私信" class="headerlink" title="发送私信"></a>发送私信</h3><p>在 MessageMapper </p>
<ul>
<li>新增 <code>insertMessage</code> 方法插入私信记录，在 <code>message-mapper.xml</code> 配置 insert 语句。 </li>
<li>新增 <code>updateMessgae</code> 方法修改私信状态，在 <code>message-mapper.xml</code> 配置 update 语句，利用 foreach 动态 sql。 </li>
</ul>
<p>在 MessageService</p>
<ul>
<li>新增 <code>addMessage</code> 发送私信方法，过滤敏感词后，调用 MessageMapper 的 <code>insertMessage</code> 。</li>
<li>新增 <code>readMessage</code> 方法读取信息，调用MessageMapper 的 <code>updateMessgae</code> 更新私信的状态为 1。</li>
</ul>
<p>在 MessageController </p>
<ul>
<li>新增 <code>getLetterIds</code> 方法，将私信集合中未读私信的 id 添加到 List 集合并返回，在 <code>getLetterDetail</code> 方法调用该方法设置已读。</li>
<li>新增 <code>sendLetter</code> 发送私信方法，设置私信信息后调用 MessageService 的 <code>addMessage</code> 发送。</li>
</ul>
<h3 id="统一异常处理"><a href="#统一异常处理" class="headerlink" title="统一异常处理"></a>统一异常处理</h3><p>在 HomeController 中增加 <code>getErrorPage</code> 方法，返回错误页面。</p>
<p>创建 ExceptionAdvice 类</p>
<ul>
<li>加上 <code>@ControllerAdvice</code> 注解，表示该类是 Controller 的全局配置类。 </li>
<li>创建 <code>handleException</code> 方法，加上 <code>@ExceptionHandler</code> 注解，该方法在 Controller 出现异常后调用，处理捕获异常。如果是异步请求返回一个 JSON 数据，否则重定向至 HomeController 的 <code>getErrorPage</code> 方法。</li>
</ul>
<h3 id="统一日志处理"><a href="#统一日志处理" class="headerlink" title="统一日志处理"></a>统一日志处理</h3><p>在 <code>pom.xml</code> 引入 aspectj 的依赖。</p>
<p>创建 ServiceLogAspect 类，添加 <code>@Aspect</code> 切面注解，配置切入点表达式，拦截所有 service 包下的方法，利用 <code>@Before</code> 记录日志。</p>
<h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><h3 id="点赞"><a href="#点赞" class="headerlink" title="点赞"></a>点赞</h3><p>创建 RedisKeyUtil 工具类</p>
<ul>
<li>定义分隔符 <code>:</code> 以及实体获得赞的 key 前缀常量 <code>like:entity</code>。 </li>
<li>新增 <code>getEntityLikeKey(int entityType,int entityId)</code> 方法，通过实体类型和实体 id 生成对应实体获得赞的 key。 </li>
</ul>
<p>创建业务层的 LikeService 类</p>
<ul>
<li>注入 RedisTemplate 实例。</li>
<li>新增 <code>like</code> 点赞方法，首先通过 RedisKeyUtil 工具类的 <code>getEntityLikeKey</code> 方法获得实体点赞的 key，然后通过 RedisTemplate 对象对 set 集合的 <code>isMember</code> 方法查询 userId 是否存在于对应 key 的 set 集合中，如果存在则移除出点赞的用户集合，如果不存在则添加到点赞的用户集合。</li>
<li>新增 <code>findEntityLikeCount</code> 方法查询实体的点赞数量，通过调用 set 集合的 <code>size</code> 方法查询元素个数。</li>
<li>新增 <code>findEntityLikeStatus</code> 方法查询某用户对某实体的点赞状态，逻辑如 <code>like</code> 方法，通过 set 集合的 <code>isMember</code> 方法实现。</li>
</ul>
<p>创建表现层的 LikeController 类</p>
<ul>
<li>注入 LikeService 和 HostHolder 实例。 </li>
<li>新增 <code>like</code> 点赞方法，调用业务层的 <code>like</code> 方法进行点赞、调用 <code>findEntityLikeCount</code> 和 <code>findEntityLikeStatus</code> 查询点赞数量和点赞状态，封装到 map 集合，然后通过工具类封装成 JSON 数据返回。 </li>
</ul>
<p>（更新首页帖子点赞数量）在表现层的 HomeController 类</p>
<ul>
<li>注入 LikeService 实例。 </li>
<li>在 <code>getIndexPage</code> 方法在通过 LikeService 类的方法获得点赞数量，存储到 map 集合。</li>
</ul>
<h3 id="收到的赞"><a href="#收到的赞" class="headerlink" title="收到的赞"></a>收到的赞</h3><p>对点赞功能进行重构</p>
<p>在 RedisUnitl 工具类</p>
<ul>
<li>新增用户获得赞 key 的前缀常量 <code>like:user</code></li>
<li>新增 <code>getUserLikeKey(int userId)</code> 方法，通过用户 id 生成对应用户获得赞的 key。</li>
</ul>
<p>在 LikeService 中</p>
<ul>
<li>重构 <code>like</code> 方法，在参数列表中加入 entityUserId 表示被点赞用户的 id，用来更新用户的被点赞数量。<ul>
<li>通过 RedisTemplate 对象的 <code>execute</code> 方法实现事务，保证被点赞用户点和点赞用户的数据更新一致。通过 <code>isMember</code> 方法查询用户的点赞状态，之后通过 <code>mutli</code> 方法开启事务。</li>
<li>当用户已点赞时，调用 <code>remove</code> 方法将当前用户从点赞用户的集合中移除，调用 <code>decrement</code> 方法将被点赞用户的被点赞数减 1；当用户未点赞时，调用 <code>add</code> 方法将当前用户添加到点赞用户的集合，调用 <code>increment</code> 方法将被点赞用户的被点赞数加 1。</li>
</ul>
</li>
<li>增加 <code>findUserLikeCount</code> 方法，以用户 id 作为 key，调用 <code>get</code> 方法查询用户所获得的点赞数。</li>
</ul>
<p>在 LikeController 中给 <code>like</code> 方法增加 entityUserId 参数即可。</p>
<h3 id="关注"><a href="#关注" class="headerlink" title="关注"></a>关注</h3><p>在 RedisUnitl 工具类</p>
<ul>
<li>新增用户关注实体（帖子、评论、用户等）和粉丝（用户）的前缀常量 <code>followee</code> 和 <code>follower</code></li>
<li>新增 <code>getFolloweeKey(int userId, int entityType)</code> 方法，通过用户 id 和实体类型生成用户关注实体的 key。</li>
<li>新增 <code>getFollowerKey(int entityType, int entityId)</code> 方法，通过实体类型和实体 id 生成实体用户粉丝的 key。</li>
</ul>
<p>创建业务层的 FollowService 类</p>
<ul>
<li>新增 <code>follow</code> 方法，当用户关注某实体时，  <ul>
<li>调用 <code>add</code> 方法将当前实体 id 和时间作为 value 和 score加入用户的关注集合。 </li>
<li>调用 <code>add</code> 方法将当前用户 id 和时间作为 value 和 score 加入实体的粉丝集合。 </li>
</ul>
</li>
<li>新增 <code>unfollow</code> 方法，当用户取消关注某实体时，  <ul>
<li>调用 <code>remove</code> 方法将当前实体从用户的关注集合移除。 </li>
<li>调用 <code>remove</code> 方法将用户从实体的粉丝集合移除。</li>
</ul>
</li>
</ul>
<h3 id="个人主页"><a href="#个人主页" class="headerlink" title="个人主页"></a>个人主页</h3><p>在业务层的 FollowService 类</p>
<ul>
<li>新增 <code>findFolloweeCount</code> 方法，调用 zset 的 <code>zcard</code> 方法查询某用户关注的实体数量。 </li>
<li>新增 <code>findFollowerCount</code> 方法，调用 zset 的 <code>zcard</code> 方法查询某实体的粉丝数量。 </li>
<li>新增 <code>hasFollowed</code> 方法，根据 zset 的 <code>zscore</code> 方法返回值查询当前用户是否关注某实体。 </li>
</ul>
<p>在 UserController 中新增 <code>getProfilePage</code> 方法获取个人主页。</p>
<ul>
<li>调用 LikeService 的 <code>findUserLikeCount</code> 查询用户获赞数，并添加到 Model 中。 </li>
<li>调用 FollowService 的<code>findFolloweeCount</code>、<code>findFollowerCount</code> 、<code>hasFollowed</code> 方法分别查询关注数量、粉丝数量、用户是否关注三项信息并添加到 Model 对象中存储。</li>
</ul>
<h3 id="关注列表和粉丝列表"><a href="#关注列表和粉丝列表" class="headerlink" title="关注列表和粉丝列表"></a>关注列表和粉丝列表</h3><p>在业务层的 FollowService 类</p>
<ul>
<li>新增 <code>findFollowees</code> 方法，查询用户关注列表，主要通过 zset 的 <code>reverseRange</code> 获取 value 即关注用户的 userId，再查询出其 user，之后通过 <code>score</code> 获取关注时间，存入 map 集合，将 map 添加到 list 列表返回。 </li>
<li>新增 <code>findFollowers</code> 方法，查询用户粉丝列表，主要通过 zset 的 <code>reverseRange</code> 获取 value 即粉丝的 userId，再查询出其 user，之后通过 <code>score</code> 获取关注时间，存入 map 集合，将 map 添加到 list 列表返回。 </li>
</ul>
<p>在表现层的 FollowController 类</p>
<ul>
<li>新增 <code>getFollowees</code> 方法，获取关注列表，存入 Model 对象。 </li>
<li>新增 <code>getFollowers</code> 方法，获取粉丝列表，存入 Model 对象。</li>
</ul>
<h3 id="优化登录模块"><a href="#优化登录模块" class="headerlink" title="优化登录模块"></a>优化登录模块</h3><h4 id="存储验证码"><a href="#存储验证码" class="headerlink" title="存储验证码"></a><strong>存储验证码</strong></h4><p>在 RedisUntil 工具类</p>
<ul>
<li>新增验证码前缀常量 <code>kaptcha</code> </li>
<li>新增 <code>getKaptchaKey</code> 方法，通过一个用户凭证（由于未登录，利用 cookie 实现）获得对应验证码的 key 值（利用 string 存储验证码）。 </li>
</ul>
<p>在表现层的 LoginController 类</p>
<ul>
<li>重构 <code>getKaptcha</code> 方法，将验证码存入 <a href="">redis</a>，key 值是当前随机生成的一个字符串，同时将该字符串存入 cookie。 </li>
<li>重构 <code>login</code> 方法，从 cookie 中获得随机字符串，生成验证码的 key 值，然后获取对应的 value 值即验证码。</li>
</ul>
<h4 id="存储登录凭证"><a href="#存储登录凭证" class="headerlink" title="存储登录凭证"></a><strong>存储登录凭证</strong></h4><p>在 RedisUntil 工具类</p>
<ul>
<li>新增登录凭证前缀常量 <code>ticket</code> </li>
<li>新增 <code>getTicketKey</code> 方法，通过字符串获得登录凭证的对应 key 值（利用 string 存储）。 </li>
</ul>
<p>在业务层的 UserService 类</p>
<ul>
<li>重构 <code>login</code> 方法，将登录凭证存入 <a href="">redis</a> 中。 </li>
<li>重构 <code>logout</code> 方法，先从 <a href="">redis</a> 中获取登录凭证对象，将状态设为无效再重新存储进 <a href="">redis</a>。 </li>
<li>重构 <code>findLoginTicket</code> 方法，根据 ticket 字符串获得对应登录凭证的 key，然后从 <a href="">redis</a> 查询登录凭证。</li>
</ul>
<p><strong>缓存用户信息</strong></p>
<p>在 RedisUntil 工具类</p>
<ul>
<li>新增用户前缀常量 <code>user</code> </li>
<li>新增 <code>getUserKey</code> 方法，通过用户 id 获得用户的对应 key 值（利用 string 存储）。 </li>
</ul>
<p>在业务层的 UserService 类</p>
<ul>
<li>新增 <code>getCache</code>，从缓存获取用户信息。</li>
<li>新增 <code>initCache</code>，从 MySQL 查询用户信息并存入 <a href="">redis</a>。</li>
<li>新增 <code>clearCache</code>，用户信息变更（更新头像，激活）时清除缓存。</li>
<li>重构 <code>findUserById</code> 方法，首先调用 <code>getCache</code>从缓存获取用户信息，如果获取为 null 则调用 <code>initCache</code>。</li>
</ul>
<h2 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h2><h3 id="发送系统通知"><a href="#发送系统通知" class="headerlink" title="发送系统通知"></a>发送系统通知</h3><p>在 CommunityConstant 接口中新增三个常量，代表三个主题：评论、点赞、关注。</p>
<p>创建 Event 类，封装事件对象，包括主题、用户 id、实体类型、实体 id、实体用户 id 以及一个 map 集合存放其它信息。</p>
<h4 id="触发事件"><a href="#触发事件" class="headerlink" title="触发事件"></a>触发事件</h4><p>创建 EventProducer 事件生产者，新增 <code>fireEvent(Event event)</code> 方法，通过 Event 获取事件类型，并将其封装成 JSON 数据，然后调用注入的 KafkaTemplate 实例的 send 方法发送。</p>
<p>在 CommentController、LikeControler、FollowController 中注入 EventProducer 实例，分别重构 <code>addComment</code> 方法、<code>like</code> 方法、<code>follow</code> 方法，封装 Event 对象，然后调用 EventProducer 的<code>fireEvent</code> 方法发布通知。</p>
<h4 id="消费事件"><a href="#消费事件" class="headerlink" title="消费事件"></a>消费事件</h4><p>创建 EventConsumer 事件消费者，消费者是被动触发的。</p>
<ul>
<li>注入 MessageService 实例。 </li>
<li>增加 <code>handleCommentMessage(ConsumerRecord record)</code> 方法，通过 <code>@KafkaListener</code> 注解，topic 包括了评论、点赞和关注。从 recored 中获取信息，封装成 Message 对象然后调用 <code>addMessage</code> 方法插入数据库。 </li>
</ul>
<p>【问题】没有向数据库插入系统通知记录，原因是 ServiceLogAspect 类进行日志处理时要获取 ServletRequestAttributes 请求对象，Kafka 的消费事件是自动触发的，没有进行新的请求，产生了请求对象的空指针异常。</p>
<h3 id="显示系统通知"><a href="#显示系统通知" class="headerlink" title="显示系统通知"></a>显示系统通知</h3><h4 id="通知列表"><a href="#通知列表" class="headerlink" title="通知列表"></a>通知列表</h4><p>在 MessageMapper 接口中</p>
<ul>
<li>新增 <code>selectLatestNotice(int userId, String topic)</code> 方法，查询某主题最新的通知。</li>
<li>新增 <code>selectNoticeCount(int userId, String topic)</code> 方法，查询某主题通知的数量。</li>
<li>新增 <code>selectNoticeUnreadCount(int userId, String topic)</code> 方法，查询未读通知的数量。</li>
<li>在 <code>message-mapper.xml</code> 配置三个方法的 sql 语句，其中查询未读通知时使用 if 动态语句，如果没有传入 topic 就查询未读总量。</li>
</ul>
<p>在业务层的 MessageService 中</p>
<ul>
<li>新增 <code>findLatestNotice</code> 方法，调用 <code>selectLatestNotice</code> 方法查询最新通知。 </li>
<li>新增 <code>findNoticeCount</code> 方法，调用 <code>selectNoticeCount</code> 方法查询某主题通知的数量。 </li>
<li>新增 <code>findNoticeUnreadCount</code> 方法，调用 <code>selectNoticeUnreadCount</code> 方法查询未读通知的数量。 </li>
</ul>
<p>在表现层的 MessageController 中新增 <code>getNoticeList</code> 方法，获取通知列表</p>
<ul>
<li>调用业务层 MessageService 的方法查询评论、点赞、关注的通知，将其封装在一个 HashMap 集合中然后添加到 Model 对象里。 </li>
<li>调用业务层 MessageService 的方法查询私信和通知的总未读数量，添加到 Model 对象里。 </li>
<li>返回 <code>notice.html</code> 页面。</li>
</ul>
<h4 id="显示通知详情"><a href="#显示通知详情" class="headerlink" title="显示通知详情"></a>显示通知详情</h4><p>在 MessageMapper 接口新增 <code>selectNotices</code> 方法，查询某个主题的通知列表，在 <code>message-mapper.xml</code> 配置 SQL。</p>
<p>在业务层的 MessageService 中新增 <code>findNotices</code> 方法，调用 <code>selectNotices</code> 方法。</p>
<p>在表现层的 MessageController 中新增 <code>getNoticeDetail</code> 方法</p>
<ul>
<li>调用 <code>findNotices</code> 方法获取通知列表详情，封装到 List 集合并存入 Model 对象。 </li>
<li>从通知集合中获取 id 集合，调用 <code>readMessage</code> 方法将消息设为已读。 </li>
<li>返回 <code>notice-detail.html</code> 页面。</li>
</ul>
<h4 id="显示未读通知总数"><a href="#显示未读通知总数" class="headerlink" title="显示未读通知总数"></a>显示未读通知总数</h4><p>创建 MessageInterceptor 拦截器</p>
<ul>
<li>注入 MessageService 实例和 HostHolder 实例。 </li>
<li>重写 <code>postHandle</code> 方法，查询私信和通知的未读数量和，然后添加到 ModelAndView 对象。 </li>
</ul>
<p>在 WebConfig 中注入 MessageInterceptor 实例，并在 <code>addInterceptors</code> 方法中添加该拦截器。</p>
<h1 id="注册功能实现"><a href="#注册功能实现" class="headerlink" title="注册功能实现"></a>注册功能实现</h1><img src="https://s2.loli.net/2022/01/17/nxOJGgXDj89VQN1.png" alt="注册" style="zoom:67%;" />

<p>用户注册，输入用户名、密码和邮箱，密码需要加盐加密再存入数据库</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user.setSalt(CommunityUtil.generateUUID().substring(<span class="number">0</span>, <span class="number">5</span>));</span><br><span class="line">user.setPassword(CommunityUtil.md5(user.getPassword() + user.getSalt()));</span><br></pre></td></tr></table></figure>

<p>默认未激活的用户状态 status=0 也会存入数据库，当然，我们会为该注册用户随机生成一个唯一的激活码一并存入数据库</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user.setStatus(<span class="number">0</span>);</span><br><span class="line">user.setActivationCode(CommunityUtil.generateUUID());</span><br></pre></td></tr></table></figure>

<p>这个激活码的作用就是用来激活该用户的。在本地环境下：<code>http://localhost:8080/activation/用户id/激活码</code> 就是该用户的激活链接；在服务器上：<code>服务器公网 IP 地址/activation/用户id/激活码</code> 就是该用户的激活链接。点击该激活链接则激活对应的用户，也就是修改数据库中用户表的字段 status 为 1，未激活的用户无法正常使用某些功能比如发表帖子等。</p>
<p>激活链接的校验逻辑就是检查一下这个链接中的用户 id 和激活码是否和数据库中存储的一样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(path = &quot;/activation/&#123;userId&#125;/&#123;code&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">activation</span><span class="params">(Model model, <span class="meta">@PathVariable(&quot;userId&quot;)</span> <span class="keyword">int</span> userId, <span class="meta">@PathVariable(&quot;code&quot;)</span> String code)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> result = userService.activation(userId, code);</span><br><span class="line">       <span class="keyword">if</span> (result == ACTIVATION_SUCCESS) &#123;</span><br><span class="line">           model.addAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;激活成功,您的账号已经可以正常使用了!&quot;</span>);</span><br><span class="line">           model.addAttribute(<span class="string">&quot;target&quot;</span>, <span class="string">&quot;/login&quot;</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result == ACTIVATION_REPEAT) &#123;</span><br><span class="line">           model.addAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;无效操作,该账号已经激活过了!&quot;</span>);</span><br><span class="line">           model.addAttribute(<span class="string">&quot;target&quot;</span>, <span class="string">&quot;/index&quot;</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           model.addAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;激活失败,您提供的激活码不正确!&quot;</span>);</span><br><span class="line">           model.addAttribute(<span class="string">&quot;target&quot;</span>, <span class="string">&quot;/index&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;/site/operate-result&quot;</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这个激活链接是如何发送给用户的呢？通过邮件。我们使用 Spring Mail 给这个用户的邮箱发送激活邮件，这个激活邮件中就包含该用户的激活链接</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 激活邮件</span></span><br><span class="line">      Context context = <span class="keyword">new</span> Context();</span><br><span class="line">      context.setVariable(<span class="string">&quot;email&quot;</span>, user.getEmail());</span><br><span class="line">      <span class="comment">// http://localhost:8080/community/activation/101/code</span></span><br><span class="line">      String url = domain + contextPath + <span class="string">&quot;/activation/&quot;</span> + user.getId() + <span class="string">&quot;/&quot;</span> + user.getActivationCode();</span><br><span class="line">      context.setVariable(<span class="string">&quot;url&quot;</span>, url);</span><br><span class="line">      String content = templateEngine.process(<span class="string">&quot;/mail/activation&quot;</span>, context);</span><br><span class="line">      mailClient.sendMail(user.getEmail(), <span class="string">&quot;激活账号&quot;</span>, content);</span><br></pre></td></tr></table></figure>

<p>对应的激活邮件模板在 <code>/mail/activation.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;icon&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://s2.loli.net/2022/01/15/a1rEymNejoTVILw.jpg&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>激活账号<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">b</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;email&#125;&quot;</span>&gt;</span>xxx@xxx.com<span class="tag">&lt;/<span class="name">b</span>&gt;</span>, 您好!</span><br><span class="line">		<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">			您正在注册吃瓜论坛, 这是一封激活邮件, 请点击</span><br><span class="line">			<span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;$&#123;url&#125;&quot;</span>&gt;</span>此链接<span class="tag">&lt;/<span class="name">a</span>&gt;</span>,</span><br><span class="line">			激活您的吃瓜账号!</span><br><span class="line">		<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>用户注册的时候会为该用户生成一个随机头像，这个头像的地址会被存入 user 表。这个随机头像的实现用的是牛客的一个头像库，包含了 1000 张头像图片，比如第 66 张图片的访问地址就是 <code>http://images.nowcoder.com/head/66t.png</code> ，所以我们随机生成 1000 以内的数字就好了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user.setHeaderUrl(String.format(<span class="string">&quot;http://images.nowcoder.com/head/%dt.png&quot;</span>, <span class="keyword">new</span> Random().nextInt(<span class="number">1000</span>)));</span><br></pre></td></tr></table></figure>



<p>注册整体逻辑：</p>
<p><img src="https://s2.loli.net/2022/01/17/fWzZn75r4XAMPqU.png" alt="注册"></p>
<h1 id="登录认证和授权功能实现"><a href="#登录认证和授权功能实现" class="headerlink" title="登录认证和授权功能实现"></a>登录认证和授权功能实现</h1><p><img src="https://s2.loli.net/2022/01/17/iaOwM7RjvQeHp2o.png" alt="登录"></p>
<h2 id="验证码机制"><a href="#验证码机制" class="headerlink" title="验证码机制"></a>验证码机制</h2><p>使用google提供的Kaptcha实现验证码，登录时要检查验证码。</p>
<p>首先，登录的时候会随机生成验证码，如何把这个验证码和当前用户对应起来，实现验证码的校验呢？</p>
<p>显然，由于这个时候用户还没有登录，我们是没有办法通过用户的 id 来唯一的对应它的验证码的。所以这个时候我们考虑生成一个随机的 id 来暂时的代替这个用户，将其和对应的验证码<strong>暂时</strong>存入 Redis 中（60s）。并且在 Cookie 中暂时存一份为这个用户生成的随机 id（60s）。</p>
<p><img src="https://s2.loli.net/2022/01/17/jkT3pF5zIUVngMt.png" alt="代码"></p>
<p>当用户点击登录按钮后，就会去 Cookie 中获取这个随机 id，然后去 Redis 中查询对应的验证码，判断用户输入的验证码是否一致。</p>
<h2 id="登录认证并持有用户状态"><a href="#登录认证并持有用户状态" class="headerlink" title="登录认证并持有用户状态"></a>登录认证并持有用户状态</h2><p>用户输入用户名和密码并且校验完验证码之后，就登录成功了，那如何在一次请求中去保存这个用户的状态？如何回显用户的信息呢？</p>
<p><img src="https://s2.loli.net/2022/01/17/yap6WJGEtA3vZcu.png" alt="状态"></p>
<p>为此，设计了一个 <code>LoginTicket</code> 类：</p>
<p><img src="https://s2.loli.net/2022/01/17/V9BTOuN43lh71eZ.png" alt="LoginTicket"></p>
<p>每个用户登录成功后，都会为其生成一个随机的唯一的登录凭证实体类对象 <code>LoginTicket</code>（包含用户 id、登录凭证字符串 ticket、是否有效、过期时间），把这个登录凭证实体类对象 存储在 Redis 中（key 就是登录凭证字符串 ticket）。而所谓登录凭证的无效，就是指用户登出后，这个凭证就会被设置为无效状态；凭证的默认过期时间是 1000s。这段代码在 <code>UserService</code> 中：</p>
<p><img src="https://s2.loli.net/2022/01/17/2nIuU6J9y85ZfPx.png" alt="userService"></p>
<p>并且，我们在 Cookie 中也同样存储了一份登录凭证的字符串 ticket，过期时间和 Redis 中的是一样的。点击记住我可以延长过期时间。这段代码在 <code>LoginController</code> 中：</p>
<p><img src="https://s2.loli.net/2022/01/17/Rga5cz7EDhUeM9H.png" alt="LoginController"></p>
<p>存储完 <code>LoginTicket</code> 后，我们就可以根据它来获取用户的状态了。我们定义了一个拦截器 <code>LoginTicketInterceptor</code>，<strong>每次请求之前都会从 Cookie 获取到 ticket，然后根据 ticket 去 Redis 中查看这个用户的登录凭证 <code>LoginTicket</code> 是否过期和是否有效</strong>，只有登录凭证有效且没有过期才会执行请求，不然就会跳转到登录界面。</p>
<p><img src="https://s2.loli.net/2022/01/17/nyorMOTPaLikEZV.png" alt="image-20220117143837876"></p>
<p>如果该用户的登录凭证有效且没有过期，那么就可以在本次请求中持有这个用户的信息了。如果持有呢？一般来说可以使用 Session，但是 Session 无法在分布式存储中发挥有效的作用。详细来说就是：客户端发送一个请求给服务器，经过负载均衡后该请求会被分发到集群中多个服务器中的其中一个，由于不同的服务器可能含有不同的 Web 服务器，而 Web 服务器之间并不能发现其他 Web 服务器中保存的 Session 信息，这样，它就会再次重新生成一个 JSESSIONID，导致之前的状态丢失。</p>
<p>所以这里我们考虑使用 <code>ThreadLocal</code> 保存用户信息，<code>ThreadLocal</code> 在每个线程中都创建了一个用户信息副本，也就是说每个线程都可以访问自己内部的用户信息副本变量。</p>
<p><code>HostHolder</code> 类：</p>
<p><img src="https://s2.loli.net/2022/01/17/Z8PGtlbBWrpNFen.png" alt="image-20220117144244285"></p>
<p>关于拦截器做的事情：</p>
<p>1）在 Controller 执行之前：检查登录凭证状态，若登录凭证有效且未过期则在本次请求中持有该用户信息</p>
<p><img src="https://s2.loli.net/2022/01/17/M43CLwBGm5jyARJ.png" alt="controller之前"></p>
<p>2）在模板引擎之前：将用户信息存入 modelAndView，便于模板引擎调用</p>
<p><img src="https://s2.loli.net/2022/01/17/tDer3PQWGji8Vxy.png" alt="存入modelandview"></p>
<p>3）在 Controller 执行之后（即服务端对本次请求做出响应后）：清理本次请求持有的用户信息（也就是 <code>ThreadLocal</code> 的 <code>remove</code>，如果没有即时 <code>remove</code> 会导致 OOM）</p>
<p><img src="https://s2.loli.net/2022/01/17/7qkABmrciQoCdSP.png" alt="image-20220117144938840"></p>
<h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><p>这里有一个点我们进行了稍微的优化。就是我们的拦截器在每次请求前通过 Cookie 去 Redis 中查询登录凭证 <code>LoginTicket</code> 然后获取到用户 id 后，需要去数据库中查询用户信息，然后才能在本次请求中持有用户信息。</p>
<p><img src="https://s2.loli.net/2022/01/17/KPEVhNWiaMYG7QH.png" alt="image-20220117145039969"></p>
<p>显然，每次请求前都需要经过这个步骤，这个访问数据库的频率还是很频繁的。因此我们考虑把登录成功的用户信息在 Redis 中保存一会，拦截器每次查询前先去 Redis 中查询，如果 Redis 中没有再去查询数据库，然后写进 Redis。OK，我们来看看 <code>findUserById</code> 方法具体是怎么实现的：</p>
<p><img src="https://s2.loli.net/2022/01/17/nCge3lLs85Uhyrb.png" alt="image-20220117145219407"></p>
<p>缓存和数据库的一致性问题的话，使用的是<strong>旁路缓存模式</strong>，也就是先更新数据库，然后直接删除缓存中的数据。比如对于修改用户密码、修改用户头像、激活用户后用户 status 的改变等，这些涉及数据库表中字段更新的操作，都需要删除缓存：</p>
<p><img src="https://s2.loli.net/2022/01/17/PuZRJ9lejKYyoix.png" alt="image-20220117145619168"></p>
<p><strong>为什么是直接删除缓存，而不是也相应的更新缓存呢</strong>？</p>
<p>因为在多线程的环境下，假设线程 A 更新了数据库中的某个字段为 1，如果在线程 A 提交之前，线程 B 又修改了这个字段为 2 并且先于线程 A 做了提交，那么线程 A 接下来提交的数据就是脏数据。直接删除缓存可以避免这个问题。</p>
<p>总的来说，这个认证流程是这样的：</p>
<ul>
<li>用户登录 —&gt; 生成登录凭证存入 Redis，Cookie 中存一份 key</li>
<li>每次执行请求都会通过 Cookie 去 Redis 中查询该用户的登陆凭证是否过期和是否有效。点击记住我可以延长登录凭证的过期时间，用户退出则其登录凭证变为无效状态</li>
<li>根据这个登录凭证对应的用户 id，去数据库中查询这个用户信息</li>
<li>使用 ThreadLocal 在本次请求中一直持有这个用户信息</li>
<li>优化点：每次请求前都需要去数据库查询这个用户信息，访问频率比较高，所以我们考虑把登录成功的用户信息在 Redis 中保存一会，拦截器每次查询前先去 Redis 中查询，然后缓存和数据库的一致性问题的话，使用的是旁路缓存模式，也就是先更新数据库，然后直接删除缓存中的数据。</li>
</ul>
<h2 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h2><p>认证的话上面大家也看到了，是我们自己写的逻辑，跳过了 Spring Security，那我们就需要把我们自己做的逻辑认证的结果存入 <code>SecurityContext</code>，以便于 Spring Security 进行授权：                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </p>
<p><img src="https://s2.loli.net/2022/01/17/adbLglU9SVAWr14.png" alt="LoginTicketInterceptor"></p>
<p><code>getAuthorities</code> 就是从数据库中获取某个用户的权限（用户的权限/类型 <code>type</code> 是存在数据库表中的）</p>
<p><img src="https://s2.loli.net/2022/01/17/EHn8I3zeDRfi6BU.png" alt="image-20220117154251631"></p>
<p>自定义这些权限拥有访问哪些路径的权力，比如：</p>
<p><img src="https://s2.loli.net/2022/01/17/OivnoLCuaqQzNMB.png" alt="image-20220117154442360"></p>
<p>另外，还需要定义一下权限不够时需要做哪些处理，注意区分下异步请求和普通请求，对于异步请求我们返回一个 JSON 字符串，对于普通请求我们直接返回错误界面即可：</p>
<p><img src="https://s2.loli.net/2022/01/17/mnOiWXJlQ2dFzta.png" alt="image-20220117154605609"></p>
<h2 id="退出登录"><a href="#退出登录" class="headerlink" title="退出登录"></a>退出登录</h2><p>Spring Security 底层会默认拦截 <code>/logout</code> 请求，进行退出处理，由于退出的逻辑我们也自己实现了（将该用户的 <code>LoginTicket</code> 状态设置为无效）：</p>
<p><img src="https://s2.loli.net/2022/01/17/n71UL6C4FcPYSDA.png" alt="image-20220117154652155"></p>
<p><img src="https://s2.loli.net/2022/01/17/RzUxylSfDjuhate.png" alt="image-20220117154719628"></p>
<p>所以我们赋予 Spring Security 一个根本不存在的退出路径，使得程序能够执行到我们自己编写的退出代码：</p>
<p><img src="https://s2.loli.net/2022/01/17/wG3HxnrLeTtouOv.png" alt="image-20220117155236507"></p>
<h1 id="发帖功能实现"><a href="#发帖功能实现" class="headerlink" title="发帖功能实现"></a>发帖功能实现</h1><h2 id="Ajax"><a href="#Ajax" class="headerlink" title="Ajax"></a>Ajax</h2><p>首先，各位不妨想一想，在平常开发中，我们是怎么在前端跟后端之间进行数据交互的？</p>
<p>最常用最原始的，form 表单。通过 form 表单以 post/get 方式提交数据，当你点击 <code>submit</code> 按钮时，浏览器会把你在 <code>input</code> 里面输入的数据提交到 form 表单中的 <code>action</code> 这个路径。</p>
<p>但是这种方式在某些情况下，对用户来说并不友好。因为在进行提交时，页面会发生跳转或刷新，我给帖子点了个赞你页面还需要刷新一下？显然这样用户体验不好。</p>
<p>为此，Ajax 应运而生。Ajax 的全称是 Asynchronous JavaScript and XML（<strong>异步</strong> JavaScript+XML），它并不是一种新的编程语言，而是一种使用现有标准的新方法。它依赖的是现有的 CSS/HTML/Javascript，而其中最核心的依赖是浏览器提供的 <code>XMLHttpRequest</code> 对象。这个对象为向服务器发送请求和解析服务器返回的响应提供了流畅的接口，使得浏览器可以发出 HTTP 请求与接收 HTTP 响应，<strong>实现在页面不刷新（局部刷新）的情况下和服务端进行数据交互</strong>。</p>
<p>Ajax 的工作原理大概是这样的：</p>
<p><img src="https://s2.loli.net/2022/01/17/JpqUXwOfRZHT7zE.png" alt="image-20220117160803071"></p>
<h2 id="同步、异步、阻塞、非阻塞"><a href="#同步、异步、阻塞、非阻塞" class="headerlink" title="同步、异步、阻塞、非阻塞"></a>同步、异步、阻塞、非阻塞</h2><p>上面我们说到 Ajax 是异步的，那么所谓同步和异步，它们其实是两种不同的<strong>消息通信机制</strong>，我们以客户端（调用者）和服务端（被调用者）之间的通信为例：</p>
<ul>
<li><strong>同步</strong>，就是指客户端调用服务端的某个东西时，在没有得到调用结果之前，该调用就不会返回。也就是说客户端必须等到这个调用返回结果才能继续往后执行；</li>
<li><strong>异步</strong>，和同步相反，调用在发出之后，这个调用就直接返回了，所以没有返回结果。换句话说，当客户端发送出了一个异步调用后，它不会立刻得到结果，而是在未来的某个时间，服务端通过状态、通知来通知客户端你的这个异步调用成功了，或者也可以通过回调函数来处理这个异步调用的返回结果。</li>
</ul>
<p>举个通俗的例子：</p>
<p>你打电话问书店老板有没有某本书，如果是同步通信机制，书店老板会说，”您稍等，我查一下”，然后开始查啊查，等查好了（可能是 5 秒，也可能是一天）告诉你结果（返回结果）；</p>
<p>而异步通信机制，书店老板直接告诉你 “我查一下啊，查好了打电话给你”，然后直接挂电话了（不返回结果）。然后查好了，他会主动打电话给你。在这里老板通过 “回电” 这种方式来回调。</p>
<p>另外，关于同步和异步，需要区别于阻塞和非阻塞，这几个概念经常容易混淆。阻塞和非阻塞关注的是<strong>客户端在等待调用结果时的状态</strong>：</p>
<ul>
<li><strong>阻塞调用</strong>，是指调用结果返回之前，客户端的当前线程会被挂起，这个调用线程只有在获取到服务端的调用结果之后才能继续运行；</li>
<li><strong>非阻塞调用</strong>，就是说即使客户端的线程无法立即获取到服务端的调用结果，这个线程也不会被阻塞，它可以继续去做其他的事情。</li>
</ul>
<p>还是上面的例子，你打电话问书店老板有没有某本书，如果是阻塞式调用，你会一直把自己 “挂起”，直到得到这本书有没有的结果；</p>
<p>如果是非阻塞式调用，你不管老板有没有告诉你，你自己就先去做别的事情了， 当然你也要偶尔过几分钟 check 一下老板这边有没有返回结果。</p>
<h2 id="发帖功能解析"><a href="#发帖功能解析" class="headerlink" title="发帖功能解析"></a>发帖功能解析</h2><p>事实上，使用 JS 编写 Ajax 代码并不容易，因为不同的浏览器对 Ajax 的实现并不相同。这意味着我们必须编写额外的代码对浏览器进行测试。不过，jQuery 团队解决了这个难题，我们只需要一行简单的代码，就可以实现 Ajax  功能，这里就不再详细赘述了。本项目使用了 jQuery，那么发帖操作是如何发送异步请求的：</p>
<p><img src="https://s2.loli.net/2022/01/17/7d2tSb4xTnmyEfH.png" alt="image-20220117161500207"></p>
<p><code>function(data)</code> 就是回调函数，是 Ajax 在请求成功后自动调用的，参数 data 就是服务端返回的这个异步请求的值。</p>
<p>Ajax 会根据我们指定的 url <code>/discuss/add</code> 来找到对应的 Controller 方法，通过 id 选择器获取用户输入的数据，封装成 JSON 字符串发送过去（即帖子的标题和内容：{“title”: title, “content”: content}），这些数据会被自动传入到 Controller 的方法形参中。Controller 方法调用完成后，Ajax 会执行回调函数，获取 Controller 返回结果并执行相应操作。</p>
<p><img src="https://s2.loli.net/2022/01/17/aDACJ2rUh14edct.png" alt="image-20220117161856160"></p>
<p>使用 Ajax 异步提交代替传统的 form 表单提交的好处在于，使用异步方式与服务器通信，不需要打断用户的操作，具有更加迅速的响应能力，使得用户体验更好。</p>
<p>我们来看看 Controller 层的方法：</p>
<p><img src="https://s2.loli.net/2022/01/17/Poa1uqrzvCNLAWF.png" alt="image-20220117162010919"></p>
<p><code>getJSONString</code> 是我们自己写的一个工具类中的方法，通过阿里开源的 fastjson 将服务端返回的消息封装成 JSON 格式的字符串：</p>
<p><img src="https://s2.loli.net/2022/01/17/Sa8MPimtwB27AZY.png" alt="image-20220117162059011"></p>
<p>真正的发帖操作在 Service 层，其实就是一个插入数据库的操作，目前做的还比较简单，帖子的内容只能是普通的文本，后面会考虑支持 MarkDown 的。另外，这里有一个<strong>过滤敏感词</strong>的操作，涉及<strong>前缀树</strong>的设计与使用，后续会单开一篇文章详细讲解。</p>
<p><code>DiscussPostService.addDiscussPost</code>：</p>
<p><img src="https://s2.loli.net/2022/01/17/71d8qonrNJb6zjV.png" alt="image-20220117162237071"></p>
<h1 id="帖子列表与分页"><a href="#帖子列表与分页" class="headerlink" title="帖子列表与分页"></a>帖子列表与分页</h1><p>帖子列表，也就是吃瓜论坛的首页，整体实现思路就是数据库利用limit 语句分页查询帖子，不过由于涉及到分页显示的问题，单独介绍。</p>
<h2 id="dao层"><a href="#dao层" class="headerlink" title="dao层"></a>dao层</h2><p>DiscussPostMapper中定义接口：</p>
<p><img src="https://s2.loli.net/2022/01/17/TaRVOAKfJX4F2BC.png" alt="DiscussPostMapper"></p>
<p>各位可以看到selectDiscussPosts方法我们传入的参数比较多，适应性比较强，这样同一个功能的接口我们只需要写一个就行了。</p>
<p>为啥说它适应性比较强，我来解释一下:对于查询用户帖子这个功能，不仅仅只有首页有这个需求，在【个人中心-我的帖子】这个模块中也有这个需求。最简单的想法可能就是分别定义两个接口，一个用来根据用户id查询帖子，一个查询所有用户的帖子，对吧?这样一看，各位是不是觉得我们一个接口完成两个需求这样的设计就技高一筹了。</p>
<p>也就是说，我们不仅需要查询所有用户的帖子，还可能需要查询某一个特定用户的帖子。所以，在 selectDiscussposts 这个接口中我们传入一个动态的参数userId，为什么说它是动态的呢?因为在MyBatis中我们可以使用<if test>实现动态的拼接<br>SOL语句，我们来看看这个接口的具体实现你就知道了，以下代码片段详见 discusspost-mapper.xml:</p>
<p><img src="https://s2.loli.net/2022/01/17/wKo5jSbTdPWxUiM.png" alt="image-20220117165505869"></p>
<p>解释一下上述代码的意思:</p>
<ul>
<li><p>当传入的userld=0时分页查找所有用户的帖子。</p>
</li>
<li><p>当传入的userld!=0时分页查找该指定用户的帖子</p>
</li>
</ul>
<p>另外，orderMode这个参数的是为了帖子按照时间排行还是按照热度排行而设计的。暂时我们不用管它，只需要知道orderMode=0的时候按照时间排行，orderMode=1的时候按照热度排行就行了。</p>
<p>当然，置顶的帖子不管是哪种排行类型那肯定仍然是置顶的，置顶帖的type=1，普通帖的type=0。所以各位也能看到orderby语句中对type的判断位居首位。<br>同样的，对于 selectdiscusspostrows 这个接口来说也是一样的，不仅首页需要查询帖子的总数，在【个人中心-我的帖子】这个模块中也有这个需求。所以我们传入的这个 userid 参数也同样是动态的，以下代码片段详见discusspost-mapper.xm1 :</p>
<p><img src="https://s2.loli.net/2022/01/17/Su4okLVGPr8yfOt.png" alt="image-20220117165844186"></p>
<h2 id="封装分页模型"><a href="#封装分页模型" class="headerlink" title="封装分页模型"></a>封装分页模型</h2><p>分页这个功能其实MyBatis拥有非常优秀的插件，这里自己写一个。</p>
<p>SQL中分页的语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tableName limit <span class="number">5</span>, <span class="number">8</span>;</span><br></pre></td></tr></table></figure>

<p>上面语句的意思是从索引5（第六条记录）开始查询，一共查询8条数据，也就是索引从5到12（第六条记录到第十三条记录）</p>
<p>分页、页码需要的信息有以下：</p>
<ol>
<li><p>当前页码current（初始化为1）</p>
</li>
<li><p>单页显示的帖子数量上限（也就是上述写的SQL分页语句中的 limit）</p>
</li>
<li><p>当前页的起始索引（也就是上述写的SQL分页语句中的 offset），可以根据当前页码current和单页现实的帖子数量上限limit计算出来：<code> offset = current * limit -limit</code></p>
</li>
<li><p>一共有多少页（总页码total） 通过总数rows计算出来：</p>
<ul>
<li>如果帖子总数是偶数： <code>total = rows / limit</code></li>
<li>如果帖子总数是奇数： <code>total = rows / limit + 1</code></li>
</ul>
</li>
<li><p>假设我们有100页的帖子，不能说分页栏直接从1显示到100吧，所以还需要知道分页栏的起始页码和终止页码：</p>
<p><img src="https://s2.loli.net/2022/01/17/ynOlk2qmsefYQJ5.png" alt="image-20220117170928657"></p>
<p>起始页码可以通过当前页码current 来计算：</p>
<ul>
<li><code>from = current -2</code>, 需要注意的是，起始页码最少是1，所以需要加个判断：<code> from &lt; 1?1 : from</code></li>
<li><code>to = current + 2</code>， 需要注意的是，终止页码不会超过总页码total，所以也需要加个判断： <code>to &gt; total ? total : to</code></li>
</ul>
</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">ahao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://ahao.ink/posts/%E8%AE%BA%E5%9D%9B%E7%B3%BB%E7%BB%9F/">https://ahao.ink/posts/%E8%AE%BA%E5%9D%9B%E7%B3%BB%E7%BB%9F/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://ahao.ink" target="_blank">ahao</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%A1%B9%E7%9B%AE/">项目</a></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2022/01/17/oZBdwSKr47scYkI.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://i.loli.net/2021/11/12/6zSDdqXlvjMakgC.jpg" target="_blank"><img class="post-qr-code-img" src="https://i.loli.net/2021/11/12/6zSDdqXlvjMakgC.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://i.loli.net/2021/11/12/Xa5GvktA3qi7VYN.jpg" target="_blank"><img class="post-qr-code-img" src="https://i.loli.net/2021/11/12/Xa5GvktA3qi7VYN.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/posts/Redis%20%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB%E5%92%8C%E7%9B%B8%E5%85%B3%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"><img class="next-cover" src="https://s2.loli.net/2021/12/07/dUknHDsS9cG3Bl6.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Redis问题汇总和相关解决方案</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="https://i.loli.net/2021/11/12/Edhsr56wxfUbuFg.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">ahao</div><div class="author-info__description">如有一味绝境，非历十方生死</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">30</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div></div><a class="button--animated" id="card-info-btn" href="https://ahao.ink"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">好 记 性 不 如 烂 笔 头</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">项目介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%8A%80%E6%9C%AF"><span class="toc-number">2.</span> <span class="toc-text">相关技术</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="toc-number">3.</span> <span class="toc-text">项目结构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF"><span class="toc-number">3.1.</span> <span class="toc-text">后端</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#entity"><span class="toc-number">3.1.1.</span> <span class="toc-text">entity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dao"><span class="toc-number">3.1.2.</span> <span class="toc-text">dao</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#service"><span class="toc-number">3.1.3.</span> <span class="toc-text">service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#controller"><span class="toc-number">3.1.4.</span> <span class="toc-text">controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#util"><span class="toc-number">3.1.5.</span> <span class="toc-text">util</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#event"><span class="toc-number">3.1.6.</span> <span class="toc-text">event</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#quartz"><span class="toc-number">3.1.7.</span> <span class="toc-text">quartz</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#config"><span class="toc-number">3.1.8.</span> <span class="toc-text">config</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ascept"><span class="toc-number">3.1.9.</span> <span class="toc-text">ascept</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF"><span class="toc-number">3.2.</span> <span class="toc-text">前端</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90"><span class="toc-number">3.2.1.</span> <span class="toc-text">前端静态资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B5%E9%9D%A2%E6%A8%A1%E6%9D%BF"><span class="toc-number">3.2.2.</span> <span class="toc-text">页面模板</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1"><span class="toc-number">4.</span> <span class="toc-text">数据库设计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E8%A1%A8"><span class="toc-number">4.1.</span> <span class="toc-text">用户表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%96%E5%AD%90%E8%A1%A8"><span class="toc-number">4.2.</span> <span class="toc-text">帖子表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%84%E8%AE%BA%E8%A1%A8"><span class="toc-number">4.3.</span> <span class="toc-text">评论表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E8%A1%A8"><span class="toc-number">4.4.</span> <span class="toc-text">消息表</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E8%BF%87%E7%A8%8B"><span class="toc-number">5.</span> <span class="toc-text">开发过程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E7%A4%BE%E5%8C%BA%E9%A6%96%E9%A1%B5"><span class="toc-number">5.1.</span> <span class="toc-text">开发社区首页</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E5%9F%BA%E6%9C%AC%E7%8E%AF%E5%A2%83"><span class="toc-number">5.1.1.</span> <span class="toc-text">搭建基本环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E7%A4%BE%E5%8C%BA%E9%A6%96%E9%A1%B5%EF%BC%88discuss-post-%E8%A1%A8%EF%BC%89"><span class="toc-number">5.1.2.</span> <span class="toc-text">开发社区首页（discuss_post 表）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E6%95%B0%E6%8D%AE%E5%B1%82"><span class="toc-number">5.1.2.1.</span> <span class="toc-text">开发数据层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E4%B8%9A%E5%8A%A1%E5%B1%82"><span class="toc-number">5.1.2.2.</span> <span class="toc-text">开发业务层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E8%A7%86%E5%9B%BE%E5%B1%82"><span class="toc-number">5.1.2.3.</span> <span class="toc-text">开发视图层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E5%88%86%E9%A1%B5%E7%BB%84%E4%BB%B6"><span class="toc-number">5.1.2.4.</span> <span class="toc-text">开发分页组件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97"><span class="toc-number">5.2.</span> <span class="toc-text">开发注册登录模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6"><span class="toc-number">5.2.1.</span> <span class="toc-text">发送邮件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E5%8A%9F%E8%83%BD"><span class="toc-number">5.2.2.</span> <span class="toc-text">注册功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-number">5.2.3.</span> <span class="toc-text">生成验证码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E9%80%80%E5%87%BA%E5%8A%9F%E8%83%BD%EF%BC%88login-ticket-%E8%A1%A8%EF%BC%89"><span class="toc-number">5.2.4.</span> <span class="toc-text">登录退出功能（login_ticket 表）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E7%99%BB%E5%BD%95%E4%BF%A1%E6%81%AF"><span class="toc-number">5.2.5.</span> <span class="toc-text">显示登录信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E5%A4%B4%E5%83%8F"><span class="toc-number">5.2.6.</span> <span class="toc-text">上传头像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%AF%86%E7%A0%81"><span class="toc-number">5.2.7.</span> <span class="toc-text">修改密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E7%99%BB%E5%BD%95%E7%8A%B6%E6%80%81"><span class="toc-number">5.2.8.</span> <span class="toc-text">检查登录状态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD"><span class="toc-number">5.3.</span> <span class="toc-text">开发核心功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E8%AF%8D%E8%BF%87%E6%BB%A4"><span class="toc-number">5.3.1.</span> <span class="toc-text">敏感词过滤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E5%B8%96%E5%AD%90"><span class="toc-number">5.3.2.</span> <span class="toc-text">发布帖子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E5%B8%96%E5%AD%90%E5%86%85%E5%AE%B9"><span class="toc-number">5.3.3.</span> <span class="toc-text">显示帖子内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E8%AF%84%E8%AE%BA%EF%BC%88comment-%E8%A1%A8%EF%BC%89"><span class="toc-number">5.3.4.</span> <span class="toc-text">显示评论（comment 表）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E8%AF%84%E8%AE%BA"><span class="toc-number">5.3.5.</span> <span class="toc-text">添加评论</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E7%A7%81%E4%BF%A1%E5%88%97%E8%A1%A8-%EF%BC%88message-%E8%A1%A8%EF%BC%89"><span class="toc-number">5.3.6.</span> <span class="toc-text">显示私信列表 （message 表）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E7%A7%81%E4%BF%A1"><span class="toc-number">5.3.7.</span> <span class="toc-text">发送私信</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">5.3.8.</span> <span class="toc-text">统一异常处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E6%97%A5%E5%BF%97%E5%A4%84%E7%90%86"><span class="toc-number">5.3.9.</span> <span class="toc-text">统一日志处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis"><span class="toc-number">5.4.</span> <span class="toc-text">Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%82%B9%E8%B5%9E"><span class="toc-number">5.4.1.</span> <span class="toc-text">点赞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%B6%E5%88%B0%E7%9A%84%E8%B5%9E"><span class="toc-number">5.4.2.</span> <span class="toc-text">收到的赞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E6%B3%A8"><span class="toc-number">5.4.3.</span> <span class="toc-text">关注</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AA%E4%BA%BA%E4%B8%BB%E9%A1%B5"><span class="toc-number">5.4.4.</span> <span class="toc-text">个人主页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E6%B3%A8%E5%88%97%E8%A1%A8%E5%92%8C%E7%B2%89%E4%B8%9D%E5%88%97%E8%A1%A8"><span class="toc-number">5.4.5.</span> <span class="toc-text">关注列表和粉丝列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97"><span class="toc-number">5.4.6.</span> <span class="toc-text">优化登录模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-number">5.4.6.1.</span> <span class="toc-text">存储验证码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E7%99%BB%E5%BD%95%E5%87%AD%E8%AF%81"><span class="toc-number">5.4.6.2.</span> <span class="toc-text">存储登录凭证</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kafka"><span class="toc-number">5.5.</span> <span class="toc-text">Kafka</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E7%B3%BB%E7%BB%9F%E9%80%9A%E7%9F%A5"><span class="toc-number">5.5.1.</span> <span class="toc-text">发送系统通知</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E4%BA%8B%E4%BB%B6"><span class="toc-number">5.5.1.1.</span> <span class="toc-text">触发事件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E4%BA%8B%E4%BB%B6"><span class="toc-number">5.5.1.2.</span> <span class="toc-text">消费事件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E7%B3%BB%E7%BB%9F%E9%80%9A%E7%9F%A5"><span class="toc-number">5.5.2.</span> <span class="toc-text">显示系统通知</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E7%9F%A5%E5%88%97%E8%A1%A8"><span class="toc-number">5.5.2.1.</span> <span class="toc-text">通知列表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E9%80%9A%E7%9F%A5%E8%AF%A6%E6%83%85"><span class="toc-number">5.5.2.2.</span> <span class="toc-text">显示通知详情</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E6%9C%AA%E8%AF%BB%E9%80%9A%E7%9F%A5%E6%80%BB%E6%95%B0"><span class="toc-number">5.5.2.3.</span> <span class="toc-text">显示未读通知总数</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.</span> <span class="toc-text">注册功能实现</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81%E5%92%8C%E6%8E%88%E6%9D%83%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.</span> <span class="toc-text">登录认证和授权功能实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%A0%81%E6%9C%BA%E5%88%B6"><span class="toc-number">7.1.</span> <span class="toc-text">验证码机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81%E5%B9%B6%E6%8C%81%E6%9C%89%E7%94%A8%E6%88%B7%E7%8A%B6%E6%80%81"><span class="toc-number">7.2.</span> <span class="toc-text">登录认证并持有用户状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">7.3.</span> <span class="toc-text">性能优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%88%E6%9D%83"><span class="toc-number">7.4.</span> <span class="toc-text">授权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95"><span class="toc-number">7.5.</span> <span class="toc-text">退出登录</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%91%E5%B8%96%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="toc-number">8.</span> <span class="toc-text">发帖功能实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Ajax"><span class="toc-number">8.1.</span> <span class="toc-text">Ajax</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E3%80%81%E5%BC%82%E6%AD%A5%E3%80%81%E9%98%BB%E5%A1%9E%E3%80%81%E9%9D%9E%E9%98%BB%E5%A1%9E"><span class="toc-number">8.2.</span> <span class="toc-text">同步、异步、阻塞、非阻塞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E5%B8%96%E5%8A%9F%E8%83%BD%E8%A7%A3%E6%9E%90"><span class="toc-number">8.3.</span> <span class="toc-text">发帖功能解析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B8%96%E5%AD%90%E5%88%97%E8%A1%A8%E4%B8%8E%E5%88%86%E9%A1%B5"><span class="toc-number">9.</span> <span class="toc-text">帖子列表与分页</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dao%E5%B1%82"><span class="toc-number">9.1.</span> <span class="toc-text">dao层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%81%E8%A3%85%E5%88%86%E9%A1%B5%E6%A8%A1%E5%9E%8B"><span class="toc-number">9.2.</span> <span class="toc-text">封装分页模型</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/%E8%AE%BA%E5%9D%9B%E7%B3%BB%E7%BB%9F/" title="论坛系统"><img src="https://s2.loli.net/2022/01/17/oZBdwSKr47scYkI.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="论坛系统"/></a><div class="content"><a class="title" href="/posts/%E8%AE%BA%E5%9D%9B%E7%B3%BB%E7%BB%9F/" title="论坛系统">论坛系统</a><time datetime="2022-01-01T05:36:41.000Z" title="发表于 2022-01-01 13:36:41">2022-01-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Redis%20%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB%E5%92%8C%E7%9B%B8%E5%85%B3%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" title="Redis问题汇总和相关解决方案"><img src="https://s2.loli.net/2021/12/07/dUknHDsS9cG3Bl6.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis问题汇总和相关解决方案"/></a><div class="content"><a class="title" href="/posts/Redis%20%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB%E5%92%8C%E7%9B%B8%E5%85%B3%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" title="Redis问题汇总和相关解决方案">Redis问题汇总和相关解决方案</a><time datetime="2021-09-26T05:36:41.000Z" title="发表于 2021-09-26 13:36:41">2021-09-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Redis%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E7%9A%84/" title="Redis是如何执行的"><img src="https://s2.loli.net/2021/12/04/uh7caJLeGXPt5mi.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis是如何执行的"/></a><div class="content"><a class="title" href="/posts/Redis%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E7%9A%84/" title="Redis是如何执行的">Redis是如何执行的</a><time datetime="2021-09-26T05:36:41.000Z" title="发表于 2021-09-26 13:36:41">2021-09-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Redis%E6%8C%81%E4%B9%85%E5%8C%96/" title="Redis持久化"><img src="https://s2.loli.net/2021/12/27/G2ApfDIMqVh3Fe5.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis持久化"/></a><div class="content"><a class="title" href="/posts/Redis%E6%8C%81%E4%B9%85%E5%8C%96/" title="Redis持久化">Redis持久化</a><time datetime="2021-09-26T05:36:41.000Z" title="发表于 2021-09-26 13:36:41">2021-09-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Redis%20%E9%AB%98%E5%8F%AF%E7%94%A8%E6%96%B9%E5%BC%8F/" title="Redis 高可用方式"><img src="https://s2.loli.net/2021/12/27/PivjdbLAGekHXOp.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis 高可用方式"/></a><div class="content"><a class="title" href="/posts/Redis%20%E9%AB%98%E5%8F%AF%E7%94%A8%E6%96%B9%E5%BC%8F/" title="Redis 高可用方式">Redis 高可用方式</a><time datetime="2021-09-26T05:36:41.000Z" title="发表于 2021-09-26 13:36:41">2021-09-26</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://s2.loli.net/2022/01/17/oZBdwSKr47scYkI.png')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By ahao</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://ahao.ink" target="_self">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'oKBwwKX9hp2tpOKDPE3PVQpL-gzGzoHsz',
      appKey: '3QBBKGzgsE11VOcVl1RElhgu',
      placeholder: '说点什么吧~',
      avatar: 'retro',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: true,
      serverURLs: '',
      emojiCDN: '//i0.hdslb.com/bfs/emote/',
      emojiMaps: {"tv_doge":"6ea59c827c414b4a2955fe79e0f6fd3dcd515e24.png","tv_親親":"a8111ad55953ef5e3be3327ef94eb4a39d535d06.png","tv_偷笑":"bb690d4107620f1c15cff29509db529a73aee261.png","tv_再見":"180129b8ea851044ce71caf55cc8ce44bd4a4fc8.png","tv_冷漠":"b9cbc755c2b3ee43be07ca13de84e5b699a3f101.png","tv_發怒":"34ba3cd204d5b05fec70ce08fa9fa0dd612409ff.png","tv_發財":"34db290afd2963723c6eb3c4560667db7253a21a.png","tv_可愛":"9e55fd9b500ac4b96613539f1ce2f9499e314ed9.png","tv_吐血":"09dd16a7aa59b77baa1155d47484409624470c77.png","tv_呆":"fe1179ebaa191569b0d31cecafe7a2cd1c951c9d.png","tv_嘔吐":"9f996894a39e282ccf5e66856af49483f81870f3.png","tv_困":"241ee304e44c0af029adceb294399391e4737ef2.png","tv_壞笑":"1f0b87f731a671079842116e0991c91c2c88645a.png","tv_大佬":"093c1e2c490161aca397afc45573c877cdead616.png","tv_大哭":"23269aeb35f99daee28dda129676f6e9ea87934f.png","tv_委屈":"d04dba7b5465779e9755d2ab6f0a897b9b33bb77.png","tv_害羞":"a37683fb5642fa3ddfc7f4e5525fd13e42a2bdb1.png","tv_尷尬":"7cfa62dafc59798a3d3fb262d421eeeff166cfa4.png","tv_微笑":"70dc5c7b56f93eb61bddba11e28fb1d18fddcd4c.png","tv_思考":"90cf159733e558137ed20aa04d09964436f618a1.png","tv_驚嚇":"0d15c7e2ee58e935adc6a7193ee042388adc22af.png"},
      enableQQ: true,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><div class="aplayer no-destroy" data-id="000PeZCQ1i4XVs" data-server="tencent" data-type="artist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="none" data-autoplay="true" muted></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})


document.addEventListener('pjax:send', function () {
  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>